# Home Assistant Configuration
# https://www.home-assistant.io/docs/configuration/

# --------------------------------------------------
# Core defaults (DO NOT REMOVE)
# --------------------------------------------------
default_config:

# --------------------------------------------------
# HTTP Configuration – Tailscale-only access
# --------------------------------------------------
http:
  server_port: 8123

  use_x_forwarded_for: true
  trusted_proxies:
    - 100.64.0.0/10           # Tailscale IPv4
    - fd7a:115c:a1e0::/48     # Tailscale IPv6
    - 127.0.0.1
    - ::1

  ip_ban_enabled: true
  login_attempts_threshold: 5

# Load frontend themes from the themes folder
# frontend:
#   themes: !include_dir_merged_named themes

# Text to speech
# tts:
#   - platform: alexa

# Input helpers
input_datetime: !include helpers/input_datetime.yaml

# Automations
automation: !include automations.yaml

# SimpliSafe Integration
# Configure via UI: Settings → Devices & Services → Add Integration → SimpliSafe
# Or add manually with credentials in secrets.yaml:
# simplisafe:
#   username: !secret simplisafe_username
#   password: !secret simplisafe_password

# Alexa Media Player (via Nabu Casa Cloud)
# Automatically discovered when Nabu Casa Cloud is configured
# Configure via UI: Settings → Devices & Services → Nabu Casa Cloud

# Example: If you need to manually configure Alexa Media Player
# alexa_media:
#   accounts:
#     - email: !secret alexa_email
#       password: !secret alexa_password

# Logger for debugging
logger:
  default: info
  logs:
    homeassistant.components.automation: debug
    homeassistant.components.simplisafe: info
    homeassistant.components.alexa_media: info


# --------------------------------------------------
# REST sensor (single fetch)
# --------------------------------------------------
sensor:
  - platform: rest
    name: "EBMUD Raw Water Data"
    resource: "http://127.0.0.1:8081/water/latest"
    scan_interval: 86400
    value_template: "{{ value_json['Reading Date'] }}"
    json_attributes:
      - "Customer GPD"
      - "WaterScore"
      - "Reading Date"


template:
  - sensor:
      - name: "EBMUD Customer GPD"
        unit_of_measurement: "gpd"
        state_class: measurement
        state: >
          {{ state_attr('sensor.ebmud_raw_water_data', 'Customer GPD') }}

      - name: "EBMUD Water Score"
        state: >
          {{ state_attr('sensor.ebmud_raw_water_data', 'WaterScore') }}

      - name: "EBMUD Reading Date"
        state: >
          {{ state_attr('sensor.ebmud_raw_water_data', 'Reading Date') }}

      # Existing PG&E sensors (unchanged)
      - name: "PG&E Electricity Energy"
        unique_id: pge_electricity_energy
        unit_of_measurement: "kWh"
        device_class: energy
        state_class: total_increasing
        state: >
          {{ states('sensor.opower_pge_elec_2889422103_consumption') | float(0) }}

      - name: "PG&E Gas Energy"
        unique_id: pge_gas_energy
        unit_of_measurement: "CCF"
        device_class: gas
        state_class: total_increasing
        state: >
          {{ states('sensor.opower_pge_gas_2886724588_consumption') | float(0) }}

      - name: "Front Door Last Clip URL"
        unique_id: front_door_last_clip_url
        state: >
          {{ state_attr('binary_sensor.simplisafe_front_door_motion', 'clip_url') }}

      - name: "Back Yard Last Clip URL"
        unique_id: back_yard_last_clip_url
        state: >
          {{ state_attr('binary_sensor.simplisafe_back_yard_motion', 'clip_url') }}


  - button:
      - name: "Front Door – Play Last Clip"
        unique_id: front_door_play_last_clip
        icon: mdi:play-circle
        press:
          service: browser.open
          data:
            url: >
              {{ state_attr('binary_sensor.simplisafe_front_door_motion', 'clip_url') }}

      - name: "Back Yard – Play Last Clip"
        unique_id: back_yard_play_last_clip
        icon: mdi:play-circle
        press:
          service: browser.open
          data:
            url: >
              {{ state_attr('binary_sensor.simplisafe_back_yard_motion', 'clip_url') }}



mqtt:
  binary_sensor:
    - name: "SimpliSafe Front Door Motion"
      unique_id: simplisafe_front_door_motion
      state_topic: "simplisafe/camera/front_door/motion"
      value_template: >
        {% if value_json is defined and value_json.event == 'motion' %}
          ON
        {% else %}
          OFF
        {% endif %}
      device_class: motion
      off_delay: 30
      json_attributes_topic: "simplisafe/camera/front_door/motion"

    - name: "SimpliSafe Back Yard Motion"
      unique_id: simplisafe_back_yard_motion
      state_topic: "simplisafe/camera/back_yard/motion"
      value_template: >
        {% if value_json is defined and value_json.event == 'motion' %}
          ON
        {% else %}
          OFF
        {% endif %}
      device_class: motion
      off_delay: 30
      json_attributes_topic: "simplisafe/camera/back_yard/motion"